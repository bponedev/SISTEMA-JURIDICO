{% extends "base.html" %}

{% block title %}Clientes - Sistema Jurídico{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-list-ul"></i> REGISTROS DE CLIENTES</h2>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">ESCRITÓRIO</label>
                <select name="office" class="form-select" onchange="this.form.submit()">
                    <option value="todos" {% if current_office == 'todos' %}selected{% endif %}>TODOS</option>
                    {% for office in offices %}
                    <option value="{{ office }}" {% if current_office == office %}selected{% endif %}>
                        {{ office.upper() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label">BUSCAR POR</label>
                <select name="filtro" class="form-select">
                    <option value="">Selecione...</option>
                    <option value="nome" {% if filtro == 'nome' %}selected{% endif %}>NOME</option>
                    <option value="cpf" {% if filtro == 'cpf' %}selected{% endif %}>CPF</option>
                    <option value="id" {% if filtro == 'id' %}selected{% endif %}>ID</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">VALOR</label>
                <input type="text" name="valor" class="form-control" value="{{ valor }}" placeholder="Digite...">
            </div>
            
            <div class="col-md-2">
                <label class="form-label">TIPO DATA</label>
                <select name="data_tipo" class="form-select">
                    <option value="">Sem filtro</option>
                    <option value="data_fechamento" {% if data_tipo == 'data_fechamento' %}selected{% endif %}>FECHAMENTO</option>
                    <option value="data_protocolo" {% if data_tipo == 'data_protocolo' %}selected{% endif %}>PROTOCOLO</option>
                </select>
            </div>
            
            <div class="col-md-1">
                <label class="form-label">DE</label>
                <input type="date" name="data_de" class="form-control" value="{{ data_de }}">
            </div>
            
            <div class="col-md-1">
                <label class="form-label">ATÉ</label>
                <input type="date" name="data_ate" class="form-control" value="{{ data_ate }}">
            </div>
            
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> BUSCAR
                </button>
                <a href="{{ url_for('clients.list_clients') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> LIMPAR
                </a>
                <button type="button" class="btn btn-danger" id="btnDeleteSelected">
                    <i class="bi bi-trash"></i> EXCLUIR SELECIONADOS
                </button>
                <button type="button" class="btn btn-warning" id="btnMigrateSelected">
                    <i class="bi bi-arrow-right-circle"></i> MIGRAR SELECIONADOS
                </button>
                <a href="{{ url_for('clients.export_csv', office=current_office) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-spreadsheet"></i> EXPORTAR CSV
                </a>
                <a href="{{ url_for('clients.export_pdf', office=current_office) }}" class="btn btn-info">
                    <i class="bi bi-file-earmark-pdf"></i> EXPORTAR PDF
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">TOTAL: {{ total }} registro(s)</h5>
            
            <div>
                <label>REGISTROS POR PÁGINA:</label>
                <select class="form-select form-select-sm d-inline-block w-auto" onchange="location.href='?office={{ current_office }}&per_page=' + this.value">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>ID</th>
                        <th>ESCRITÓRIO</th>
                        <th>NOME</th>
                        <th>CPF</th>
                        <th>TIPO AÇÃO</th>
                        <th>DATA FECHAMENTO</th>
                        <th>NÚMERO PROCESSO</th>
                        <th>AÇÕES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td><input type="checkbox" class="record-check" data-id="{{ record.id }}" data-office="{{ record.office }}"></td>
                        <td>{{ record.id }}</td>
                        <td>{{ record.office.upper() }}</td>
                        <td>{{ record.nome }}</td>
                        <td>{{ record.cpf }}</td>
                        <td>{{ record.tipo_acao or '-' }}</td>
                        <td>{{ record.data_fechamento or '-' }}</td>
                        <td>{{ record.numero_processo or '-' }}</td>
                        <td>
                            <a href="{{ url_for('clients.edit_client', office=record.office, client_id=record.id) }}" 
                               class="btn btn-sm btn-warning" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">Nenhum registro encontrado</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if total_pages > 1 %}
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="?office={{ current_office }}&page={{ page - 1 }}&per_page={{ per_page }}">Anterior</a>
                </li>
                
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                    <li class="page-item"><a class="page-link" href="?office={{ current_office }}&page={{ p }}&per_page={{ per_page }}">{{ p }}</a></li>
                    {% elif p == page - 3 or p == page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?office={{ current_office }}&page={{ page + 1 }}&per_page={{ per_page }}">Próxima</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

{% if current_office != 'todos' %}
<div class="mt-3">
    <a href="{{ url_for('clients.list_deleted', office=current_office) }}" class="btn btn-secondary">
        <i class="bi bi-trash3"></i> VER EXCLUÍDOS
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Selecionar todos
$('#selectAll').on('change', function() {
    $('.record-check').prop('checked', $(this).prop('checked'));
});

// Excluir selecionados
$('#btnDeleteSelected').on('click', function() {
    const checked = $('.record-check:checked');
    
    if (checked.length === 0) {
        alert('Selecione pelo menos um registro.');
        return;
    }
    
    if (!confirm(`Confirma a exclusão de ${checked.length} registro(s)?`)) {
        return;
    }
    
    const ids = [];
    const office = checked.first().data('office');
    
    checked.each(function() {
        ids.push($(this).data('id'));
    });
    
    $.post('{{ url_for("clients.delete_clients") }}', {
        office: office,
        'client_ids[]': ids
    })
    .done(function(data) {
        alert(data.message);
        location.reload();
    })
    .fail(function(xhr) {
        alert('Erro: ' + (xhr.responseJSON?.message || 'Erro desconhecido'));
    });
});

// Migrar selecionados
$('#btnMigrateSelected').on('click', function() {
    const checked = $('.record-check:checked');
    
    if (checked.length === 0) {
        alert('Selecione pelo menos um registro.');
        return;
    }
    
    const office = checked.first().data('office');
    const target = prompt('Digite o código do escritório de destino:');
    
    if (!target) return;
    
    if (!confirm(`Migrar ${checked.length} registro(s) para ${target}?`)) {
        return;
    }
    
    const ids = [];
    checked.each(function() {
        ids.push($(this).data('id'));
    });
    
    $.post('{{ url_for("clients.migrate_selected") }}', {
        'ids[]': ids,
        office_current: office,
        office_target: target
    })
    .done(function(data) {
        alert(data.message);
        location.reload();
    })
    .fail(function(xhr) {
        alert('Erro: ' + (xhr.responseJSON?.message || 'Erro desconhecido'));
    });
});
</script>
{% endblock %}
